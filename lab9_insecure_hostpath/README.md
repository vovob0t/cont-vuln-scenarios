# Неправильное использование hostPath – доступ к критическим файлам хоста
# История

В одном из департаментов компании разработчики допустили серьезную ошибку при конфигурации Kubernetes. Один из pod’ов, отвечающих за кэширование данных, был настроен с томом типа hostPath, который монтировал критически важную директорию хоста (например, /etc). В результате уязвимый pod получил доступ ко всей конфигурации ОС, включая файлы с паролями и сертификатами. Опасность заключалась в том, что злоумышленник, сумевший запустить эксплойт внутри такого pod’а, мог легко получить доступ к файлам хоста и использовать их для дальнейшей атаки. Ваша задача – воспроизвести данную ситуацию, исследовать её и затем исправить конфигурацию, заменив hostPath на более безопасное решение.

# Инструкции по запуску уязвимого стенда
1. Убедитесь, что у вас запущен локальный кластер (например, Minikube или Kind):
```sh
minikube start
```

2. Примените манифест:
```sh
kubectl apply -f lab9_hostpath/pod-vulnerable.yaml
```

3. Проверьте статус pod:
```sh
kubectl get pods sensitive-pod
```

4. Войдите в pod, чтобы проверить содержимое смонтированной директории::
- Зайти в pod
```sh
kubectl exec -it sensitive-pod -- sh
```
- Внутри pod’а перейдите в смонтированную директорию и прочитайте содержимое файла (например, /mnt/host_etc/passwd):
```sh
ls -la /host-etc
```
Вы должны увидеть файлы критически важных директорий хоста, такие как passwd, shadow и другие. Это сигнализирует об опасной конфигурации.

В данному случае запускаемый POD размещен в специальном окружении minikube, поэтому мы получаем доступ к его файлам.

# Расследование и анализ

## Проверка безопасности:
Убедитесь, что том типа hostPath имеет доступ ко всей директории /etc. Это позволяет любому процессу в контейнере читать и, теоретически, изменять системные файлы на хосте.

## Оценка риска:
Если злоумышленник получит доступ к такому pod’у (например, из-за эксплуатации уязвимости в приложении), он сможет получить конфиденциальную информацию или даже изменить критичные файлы хоста.

# Фикс
Чтобы устранить проблему, рекомендуется либо вовсе не использовать hostPath, либо ограничить доступ к безопасной директории (например, использовать emptyDir или настроенный volume). В данном случае исправим pod следующим образом: например, используем пустой том emptyDir, если кэш должен быть временным.

# Инструкции по запуску уязвимого стенда
1. Удалите уязвимый pod:
```sh
kubectl delete pod sensitive-pod
```

2. Примените исправленный манифест:
```sh
kubectl apply -f fixed/pod-fixed.yaml
```
3. Проверка:
- Проверить статус pod
```sh
kubectl get pods sensitive-pod-fixed
```

- Войдите в pod и убедитесь, что в директории /host_etc отсутствуют файлы (либо такого монтирования вообще нет):
```sh
kubectl exec -it sensitive-pod-fixed -- sh
ls -la /host-etc
```
Вы увидите пустую директорию или временное хранилище, которое не содержит системных файлов хоста – уязвимость устранена.
