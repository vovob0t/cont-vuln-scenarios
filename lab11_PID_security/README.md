# Сценарий 11 Неограниченные права в PodSecurityContext
## Легенда
В одной организации специалисты по обеспечению безопасности обнаружили, что в кластере был задеплоен под с неправильной конфигурацией, включающей параметры `hostPID: true` и `privileged: true`. Благодаря этому контейнер получил доступ к процессам хоста, что позволило злоумышленнику просматривать и даже изменять критические системные процессы. Руководство решило продемонстрировать данную уязвимость, а затем устранить её посредством корректировки настроек PodSecurityContext.

## Запуск сценария
- Убедиться, что запущен кластер `k8s` или запустить его с помощью `minikube`:
```sh
minikube start
```
- Далее необходимо применить манифест уязвимого пода
```sh
kubectl apply -f pod-vulnerable.yaml
```

- Проверить статус пода:
```sh
kubectl get pod monitoring-root -o wide
```

- После этого специалист входит в под:
```sh
kubectl exec -it monitoring-root -- sh
```

- Внутри пода устанавливается утилита для просмотра процессов:
```sh
apk add procps
```

- Выполняется команда для отображения процессов:
```sh
ps aux
```

## Обнаружения уязвимости
- Специалист может проверить уязвимую конфигурацию командой:
```sh
kubectl get pod monitoring-root -o yaml | grep hostPID
```

## Исправление уязвимости
Для устранения проблемы в новой версии необходимо задеплоить под без использования hostPID и привилегированного режима, а также обеспечить запуск процесса от непривилегированного пользователя.

- При необходимости удалить уязвимый под:
```sh
kubectl delete pod monitoring-root
```

- Применить исправленный манифест:
```sh
kubectl apply -f pod-fixed.yaml
```

- Проверить статус нового пода:
```sh
kubectl get pod monitoring-safe
```

- Специалист заходит в под:
```sh
kubectl exec -it monitoring-safe -- sh
```

- Выполнение команды `ps aux` должно показывать только процессы внутри пода, а доступ к процессам хоста отсутствует.

## Объяснение причин возникновения уязвимости
Уязвимость появилась в результате неосторожной настройки: параметр hostPID: true разрешает контейнеру видеть и взаимодействовать с процессами хоста, а параметр privileged: true открывает все возможности операционной системы. Отсутствие настройки runAsNonRoot приводит к тому, что процесс внутри контейнера запускается от имени root. Такая комбинация параметров позволяет злоумышленнику использовать под для вмешательства в работу системных процессов узла.








