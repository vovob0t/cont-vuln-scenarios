# Сценарий 12: «Отсутствие проверки образов (Image Policy Bypass)»
## Легенда
В одном кластере Kubernetes сотрудники отдела безопасности обнаружили, что в результате отсутствия механизмов проверки образов был задеплоен контейнер с образом, полученным из публичного реестра без должной верификации. Оказалось, что образ, названный vulhub/nginx-backdoor, содержит вредоносный код, позволяющий злоумышленнику получить обратную оболочку. Отсутствие политики проверки образов создало риск атаки на цепочку поставок. Задачей является воспроизведение уязвимой конфигурации, демонстрация эксплуатации и последующее внедрение мер для ограничения запуска неподписанных или подозрительных образов.

## Инструкции по запуску

- Убедиться, что запущен кластер `k8s` или запустить его с помощью `minikube`:
```sh
minikube start
```
- Убедившись, что кластер Kubernetes запущен, специалист применяет манифест:
```sh
kubectl apply -f lab12_imagepolicy/deployment-vulnerable.yaml
```

- Проверяется создание pod:
```sh
kubectl get pods
```

- Для доступа к приложению специалист выполняет port-forward:
```sh
kubectl port-forward pod/$(kubectl get pods -l app=fake-nginx -o jsonpath='{.items[0].metadata.name}') 8080:80
```

- Затем посредством браузера или curl специалист обращается по адресу `http://localhost:8080` и наблюдает работу веб-сервера. Дополнительно, специалист может изучить логи контейнера для выявления признаков вредоносной активности.

## Использования уязвимости

Воспользовавшись уязвимостью, специалист может обнаружить, что образ содержит обратный shell или другой вредоносный код. Например, просмотр логов контейнера может продемонстрировать неожиданные подключения или команды, выполняемые с нестандартными параметрами.

Специалист может выполнить:
```sh
kubectl logs -l app=fake-nginx
```
и убедиться, что в логах присутствуют сообщения, не характерные для обычного Nginx.

## Исправление уязвимости

Чтобы предотвратить подобные атаки, необходимо ввести механизмы контроля запуска образов. Одним из решений является использование системы политики, например, OPA Gatekeeper.

- Прежде всего, если Gatekeeper ещё не установлен в кластере, администратор должен его установить. Например, для Minikube или любого другого кластера можно выполнить:
```sh
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml
```

После успешной установки Gatekeeper, в кластере появляется ряд CRD (CustomResourceDefinitions) для ConstraintTemplate и Constraint.

- Создание ограничения для Docker-образов

Администратор может создать Constraint Template, который ограничивает допустимые репозитории для образов. 
==смотреть файл allowed-repos.yaml==

Данный шаблон определяет, что в pod’ах могут использоваться только образы, начинающиеся с указанных префиксов.

*Обратите внимание, что в данном примере функция allowed(image) в шаблоне довольно условна. Администратор может создать более точные правила, используя регулярные выражения или более детальную проверку префиксов. Главное – разрешить только проверенные источники.* 

- Далее создаётся Constraint, который использует данный шаблон.
==смотреть файл k8sallowedrepos-constraint.yaml==

## Применение политики и проверка

- Применить Constraint Template:
```sh
kubectl apply -f allowed-repos.yaml
```

- Применить Constraint:
```sh
kubectl apply -f k8sallowedrepos-constraint.yaml
```

- После применения ограничения, при попытке задеплоить pod, использующий неподтверждённый образ, Gatekeeper отклонит запрос. Чтобы это проверить, администратор может снова применить манифест из уязвимого сценария (например, deployment-vulnerable.yaml с образом vulhub/nginx-backdoor).
```sh
kubectl apply -f lab12_imagepolicy/deployment-vulnerable.yaml
```

- Gatekeeper должен вернуть сообщение об ошибке (deny), информируя, что образ не соответствует политики безопасности. Пример сообщения может выглядеть следующим образом:
```sh
Изображение 'vulhub/nginx-backdoor' не находится в списке разрешённых
```

- После этого можно удалить уязвимый Deployment
```bash
kubectl delete -f lab12_imagepolicy/deployment-vulnerable.yaml
```

- Затем деплой должен быть пересмотрен и заменён на использование официального образа
==смотреть файл deployment-fixed==
- Применить новый деплой:
```sh
kubectl apply -f lab12_imagepolicy/deployment-fixed.yaml
```


## Объяснение причины возникновения уязвимости

Уязвимость возникает потому, что по умолчанию кластер Kubernetes не применяет никаких ограничений на источники образов. Это позволяет злоумышленникам или неосторожным пользователям задеплоить контейнер с вредоносным кодом из произвольного реестра. Отсутствие цифровых подписей и проверки репозиториев приводит к тому, что вредоносные образы могут быть запущены в кластере. Внедрение механизмов политики, таких как OPA Gatekeeper, позволяет ограничить этот риск.

