# Неправильная конфигурация Ingress – публичный доступ к внутреннему сервису

# История инцидента
В одном из кластеров Kubernetes был развернут административный интерфейс для управления внутренним сервисом. Инженеры по ошибке настроили Ingress таким образом, что этот интерфейс оказался доступен из интернета без каких-либо ограничений. Это привело к тому, что злоумышленники получили возможность просматривать и изменять настройки приложения, что могло повлечь за собой масштабные последствия. Ваша задача – воспроизвести уязвимую конфигурацию, исследовать проблему и затем исправить Ingress так, чтобы доступ к внутреннему сервису был ограничен (например, через IP whitelisting или базовую аутентификацию).

# Запуск уязвимой версии

1. Убедитесь, что у вас запущен кластер (например, Minikube):

```sh
minikube start
minikube addons enable ingress
```

2. Создайте namespace:
```sh
kubectl apply -f namespace.yaml
```

3. Примените Deployment:
```sh
kubectl apply -f deployment.yaml
```

4. Примените Service:
```sh
kubectl apply -f service.yaml
```

5. Примените уязвимый Ingress:
```sh
kubectl apply -f ingress-vulnerable.yaml
```

6. Проверьте ресурсы:
```sh
kubectl get all -n admin-ns
kubectl get ingress -n admin-ns
```

7. Для тестирования уязвимой конфигурации можно изменить файл /etc/hosts на своей машине, добавив запись:

```pgsql
127.0.0.1   admin.example.com
```
Затем в браузере откройте http://admin.example.com – вы должны увидеть страницу, раздаваемую Nginx, которая симулирует административный интерфейс. Обратите внимание, что доступ открыт для всех без какой-либо аутентификации или ограничений.

# Анализ и расследование

- Риск:
Административный интерфейс стал доступен извне без защиты. Любой пользователь с доступом к интернету (или к кластеру) может зайти по адресу admin.example.com и потенциально получить контроль над системой.

- Проверка:
Пройдитесь по логам Ingress Controller (например, в Minikube можно получить доступ к Ingress через `kubectl logs <ingress-controller-pod>`) – убедитесь, что трафик поступает от любого IP. Это подтверждает отсутствие ограничений.

# Исправленная версия (ingress-fixed.yaml)
В фиксе добавим ограничение доступа по IP (whitelisting), используя аннотацию nginx-ingress, которая позволяет задать список разрешённых IP-адресов. Для примера разрешим доступ только с локального адреса (127.0.0.1).

# Запуск исправленной версии

1. Удалите уязвимый Ingress:
```sh
kubectl delete -f ingress-vulnerable.yaml -n admin-ns
```

2. Примените исправленный Ingress:
```sh
kubectl apply -f ingress-fixed.yaml -n admin-ns
```

3. Проверьте ресурс:
```sh
kubectl get ingress -n admin-ns
```

4. Попробуйте зайти в браузере на http://admin.example.com. Теперь доступ будет разрешён только с локального хоста (IP 127.0.0.1). Если попробуете открыть страницу с другого устройства или изменить IP, доступ будет отвергаться.
